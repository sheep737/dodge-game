<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
<title>Pong VS – Improved</title>
<style>
  html,body { margin:0; padding:0; height:100%; background:#111; overflow:hidden; }

  /* ▼ バージョン表示 */
  #versionTag{
    position:fixed; top:1vh; right:2vw;
    color:#fff; font-size:3vw; z-index:200;
    opacity:0.7;
  }

  #roomPanel {
    position:fixed; inset:0; background:#000c;
    display:flex; flex-direction:column;
    justify-content:center; align-items:center; gap:2rem;
    z-index:20;
  }
  #roomPanel input { font-size:5vw; padding:1rem; width:70vw; }
  #roomPanel button { font-size:5vw; padding:1rem 2rem; }

  #startBtn {
    position:fixed;
    top:10vh; right:3vw;
    font-size:6vw; padding:1rem 2rem;
    z-index:150;
    display:none;
  }

  #stage { position:fixed; inset:0; background:#222; display:none; }

  #ball {
    position:absolute;
    width:30px; height:30px;
    background:#ff6; border-radius:50%;
  }

  .paddle {
    position:absolute;
    width:160px; height:20px;
    background:#4af; border-radius:8px;
  }
  #me { bottom:80px; left:100px; }
  #op { top:80px; left:100px; background:#f55; }

  #controls {
    position:fixed; bottom:40px;
    left:0; right:0; display:flex;
    justify-content:center; gap:20vw;
    z-index:140;
  }
  .btn {
    font-size:8vw; padding:1rem 2rem;
    background:#333; color:#fff;
    border:2px solid #fff; border-radius:8px;
    user-select:none;
  }

  #msg {
    position:fixed; inset:0;
    display:flex; justify-content:center; align-items:center;
    font-size:9vw; color:#fff;
    opacity:0; transition:0.4s;
    z-index:170;
  }
</style>
</head>

<body>

<div id="versionTag">v1.0.3</div>

<!-- Room 設定 -->
<div id="roomPanel">
  <div style="color:#fff;font-size:6vw;">Room ID を入力</div>
  <input id="roomInput" placeholder="例: room123" />
  <div>
    <button id="joinBtn">Join</button>
    <button id="createBtn">Random</button>
  </div>
</div>

<button id="startBtn">START</button>

<!-- ゲーム -->
<div id="stage">
  <div id="ball"></div>
  <div id="me" class="paddle"></div>
  <div id="op" class="paddle"></div>

  <div id="controls">
    <div id="leftBtn"  class="btn">◀</div>
    <div id="rightBtn" class="btn">▶</div>
  </div>

  <div id="msg"></div>
</div>

<script type="module">
/* ===== Firebase ===== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set, onValue, onDisconnect } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAs8DqxHiRzveAMJ7j-UMBWKp6ztGF-hd8",
  authDomain: "ddgame-6f5f8.firebaseapp.com",
  databaseURL: "https://ddgame-6f5f8-default-rtdb.firebaseio.com",
  projectId: "ddgame-6f5f8",
  storageBucket: "ddgame-6f5f8.firebasestorage.app",
  messagingSenderId: "172945824128",
  appId: "1:172945824128:web:e3c7333928e1545aa1c965"
};
const app = initializeApp(firebaseConfig);
const db  = getDatabase(app);

/* ===== UI ===== */
const roomPanel=document.getElementById("roomPanel");
const roomInput=document.getElementById("roomInput");
const joinBtn=document.getElementById("joinBtn");
const createBtn=document.getElementById("createBtn");
const startBtn=document.getElementById("startBtn");

const stage=document.getElementById("stage");
const me=document.getElementById("me");
const op=document.getElementById("op");
const ball=document.getElementById("ball");
const msg=document.getElementById("msg");

const leftBtn=document.getElementById("leftBtn");
const rightBtn=document.getElementById("rightBtn");

/* ===== 状態 ===== */
let roomId=null;
let myId=Math.random().toString(36).slice(2,10);
let hostId=null;

let myX=150, opX=150;       // px
let bx=150,  by=300;        // px
let vx=2.2,  vy=3.4;        // ★ 遅め
let moveLeft=false, moveRight=false;

let playersRef=null;
let ballRef=null;
let controlRef=null;
let gameRunning=false;

/* ===== Random 作成 ===== */
createBtn.onclick=()=>{
  roomInput.value="room-"+Math.floor(Math.random()*99999);
};

/* ===== Join ===== */
joinBtn.onclick=()=>{
  const id=roomInput.value.trim();
  if(!id) return alert("Room ID を入力");
  joinRoom(id);
};

function joinRoom(id){
  roomId=id;
  roomPanel.style.display="none";
  stage.style.display="block";
  startBtn.style.display="block";

  playersRef = ref(db,`rooms/${roomId}/players`);
  ballRef    = ref(db,`rooms/${roomId}/ball`);
  controlRef = ref(db,`rooms/${roomId}/control/start`);

  /* 自分を登録 */
  const myRef = ref(db,`rooms/${roomId}/players/${myId}`);
  set(myRef,{x:myX});
  onDisconnect(myRef).remove();

  /* HOST 判定 */
  onValue(playersRef,s=>{
    const v=s.val()||{};
    hostId=Object.keys(v)[0];
  });

  /* 相手の位置更新 */
  onValue(playersRef,s=>{
    const v=s.val()||{};
    for(const k in v){
      if(k!==myId) opX=v[k].x;
    }
  });

  /* START 同期 */
  onValue(controlRef,s=>{
    if(s.val()==="go"){
      startBtn.style.display="none";
      gameRunning=true;
    }
  });

  /* ボール同期 */
  onValue(ballRef,s=>{
    const v=s.val();
    if(v){
      bx=v.bx; by=v.by; vx=v.vx; vy=v.vy;
    }
  });

  gameLoop();
}

/* ===== START ===== */
startBtn.onclick=()=>{
  if(myId===hostId){
    set(controlRef,"go");
    set(ballRef,{bx,by,vx,vy});
  }
  startBtn.style.display="none";
  gameRunning=true;
};

/* ===== ボタン操作（ pointer に統一 ）===== */
function bind(btn,on,off){
  btn.addEventListener("pointerdown",e=>{e.preventDefault(); on();});
  btn.addEventListener("pointerup",e=>{e.preventDefault(); off();});
  btn.addEventListener("pointerleave",off);
}
bind(leftBtn, ()=>moveLeft=true, ()=>moveLeft=false);
bind(rightBtn,()=>moveRight=true,()=>moveRight=false);

/* ===== ゲームループ ===== */
function gameLoop(){
  /* パドル移動 */
  if(moveLeft)  myX -= 4;
  if(moveRight) myX += 4;
  myX = Math.max(0, Math.min(window.innerWidth-160, myX));

  me.style.left = myX+"px";
  set(ref(db,`rooms/${roomId}/players/${myId}`),{x:myX});

  op.style.left = opX+"px";

  /* ボール */
  if(gameRunning){

    /* HOST が物理計算 */
    if(myId===hostId){
      bx += vx;
      by += vy;

      /* 壁反射 */
      if(bx < 0 || bx > window.innerWidth-30) vx *= -1;

      /* ▼ 当たり判定（完全に修正） */
      const bw=30, bh=30;
      const pw=160, ph=20;

      /* 自分のパドル */
      if(
        by+bh > window.innerHeight-80-20 && 
        by <  window.innerHeight-80 &&
        bx+bw > myX && bx < myX+pw
      ){
        vy = -Math.abs(vy);
      }

      /* 相手のパドル */
      if(
        by < 80+20 &&
        by+bh > 80 &&
        bx+bw > opX && bx < opX+pw
      ){
        vy = Math.abs(vy);
      }

      /* Lose / Win */
      if(by > window.innerHeight){
        msg.textContent="YOU LOSE";
        msg.style.opacity=1;
        setTimeout(()=>location.reload(),2000);
      }
      if(by+bh < 0){
        msg.textContent="YOU WIN!";
        msg.style.opacity=1;
        setTimeout(()=>location.reload(),2000);
      }

      /* 同期 */
      set(ballRef,{bx,by,vx,vy});
    }

    /* 描画 */
    ball.style.left = bx+"px";
    ball.style.top  = by+"px";
  }

  requestAnimationFrame(gameLoop);
}
</script>

</body>
</html>