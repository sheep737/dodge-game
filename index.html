<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
<title>VS Paddle Duel – Fixed</title>
<style>
  html,body { margin:0; padding:0; height:100%; background:#111; overflow:hidden; }
  #roomPanel { position:fixed; inset:0; background:#000c; display:flex; flex-direction:column; justify-content:center; align-items:center; gap:1.4rem; z-index:20; }
  #roomPanel input { font-size:5vw; padding:0.6rem 1rem; width:70vw; }
  #roomPanel button { font-size:5vw; padding:0.6rem 1.2rem; }

  #stage { position:fixed; inset:0; background:#222; display:none; overflow:hidden; }
  #ball  { position:absolute; width:4vw; height:4vw; max-width:35px; max-height:35px; border-radius:50%; background:#ff6; z-index:5; }

  .paddle {
    position:absolute;
    width:20vw; height:3vh;
    background:#4af;
    border-radius:8px;
  }
  #me    { bottom:16vh; left:40vw; }
  #op    { top:16vh; left:40vw; background:#f55; }

  #controls {
    position:fixed;
    bottom:3vh;
    left:0; right:0;
    display:flex; justify-content:center; gap:10vw;
    z-index:30;
  }
  .btn {
    font-size:6vw;
    padding:1.2rem 1.6rem;
    background:#333; color:#fff;
    border:2px solid #fff;
    border-radius:8px;
    user-select:none;
  }

  #msg {
    position:fixed; inset:0;
    display:flex; justify-content:center; align-items:center;
    font-size:10vw; color:#fff;
    pointer-events:none;
    opacity:0; transition:0.4s;
    z-index:40;
  }
</style>
</head>

<body>

<!-- Room -->
<div id="roomPanel">
  <div style="color:#fff;font-size:6vw;">Room ID を入力して対戦</div>
  <input id="roomInput" placeholder="例: vs123" />
  <div>
    <button id="joinBtn">Join</button>
    <button id="createBtn">Random</button>
  </div>
</div>

<!-- Stage -->
<div id="stage">
  <div id="ball"></div>
  <div id="me" class="paddle"></div>
  <div id="op" class="paddle"></div>

  <div id="controls">
    <div id="leftBtn"  class="btn">◀</div>
    <div id="rightBtn" class="btn">▶</div>
  </div>

  <div id="msg"></div>
</div>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getDatabase, ref, set, onValue, push, onDisconnect
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyAs8DqxHiRzveAMJ7j-UMBWKp6ztGF-hd8",
    authDomain: "ddgame-6f5f8.firebaseapp.com",
    databaseURL: "https://ddgame-6f5f8-default-rtdb.firebaseio.com",
    projectId: "ddgame-6f5f8",
    storageBucket: "ddgame-6f5f8.firebasestorage.app",
    messagingSenderId: "172945824128",
    appId: "1:172945824128:web:e3c7333928e1545aa1c965",
    measurementId: "G-FG0645HHZD"
};

const app = initializeApp(firebaseConfig);
const db  = getDatabase(app);

/* UI */
const roomPanel=document.getElementById("roomPanel");
const roomInput=document.getElementById("roomInput");
const joinBtn=document.getElementById("joinBtn");
const createBtn=document.getElementById("createBtn");
const stage=document.getElementById("stage");

const me = document.getElementById("me");
const op = document.getElementById("op");
const ball = document.getElementById("ball");
const msg = document.getElementById("msg");

const leftBtn = document.getElementById("leftBtn");
const rightBtn = document.getElementById("rightBtn");

/* 状態 */
let roomId=null;
let myId = Math.random().toString(36).slice(2,10);
let hostId=null;
let playersRef=null;
let ballRef=null;
let myX=50, opX=50;
let bx=50, by=50, vx=0.6, vy=0.9;
let moveLeft=false, moveRight=false;
let gameStarted=false;

/* ===== Join / Create ===== */
createBtn.onclick=()=>{
  roomInput.value = "room-"+Math.floor(Math.random()*99999);
};

joinBtn.onclick=()=>{
  const id = roomInput.value.trim();
  if(!id) return alert("Room IDを入力してください");
  joinRoom(id);
};

function joinRoom(id){
  roomId=id;
  roomPanel.style.display="none";
  stage.style.display="block";

  playersRef = ref(db,`rooms/${roomId}/players`);
  ballRef    = ref(db,`rooms/${roomId}/ball`);

  // 誰もいなければ自分がホスト
  onValue(playersRef, snap=>{
    const v = snap.val()||{};
    const keys = Object.keys(v);
    hostId = keys.length === 0 ? myId : keys[0];
  },{onlyOnce:true});

  // 自分登録
  const myRef = ref(db,`rooms/${roomId}/players/${myId}`);
  set(myRef,{x:50});
  onDisconnect(myRef).remove();

  // 相手の位置
  onValue(playersRef, snap=>{
    const v = snap.val()||{};
    for(const k in v) if(k!==myId) opX=v[k].x;
  });

  // ボール同期
  onValue(ballRef, snap=>{
    const v=snap.val();
    if(!v) return;
    bx=v.bx; by=v.by; vx=v.vx; vy=v.vy;
    gameStarted = true;  // ← 初回ボール受信で開始
  });

  // ホストは初期ボール生成
  if(hostId===myId){
    set(ballRef,{bx:50,by:50,vx,vy});
  }

  gameLoop();
}

/* ボタン入力 */
function bindBtn(btn, on, off){
  btn.addEventListener("touchstart", on);
  btn.addEventListener("touchend", off);
  btn.addEventListener("mousedown", on);
  btn.addEventListener("mouseup", off);
}
bindBtn(leftBtn, ()=>moveLeft=true, ()=>moveLeft=false);
bindBtn(rightBtn, ()=>moveRight=true, ()=>moveRight=false);

/* ===== ゲームループ ===== */
function gameLoop(){

  if(moveLeft)  myX -= 1.2;
  if(moveRight) myX += 1.2;
  myX = Math.max(5, Math.min(95, myX));
  me.style.left = myX+"vw";

  op.style.left = opX+"vw";

  // パドル更新
  set(ref(db,`rooms/${roomId}/players/${myId}`),{x:myX});

  if(gameStarted){

    // ホストのみボールを動かす
    if(myId === hostId){
      bx += vx;  
      by += vy;

      if(bx<0||bx>100) vx*=-1;
      if(by<0) vy*=-1;

      // パドル反射
      const py = 16;

      if(by >= py-3 && by <= py+3){
        if(Math.abs(bx - myX) < 12) vy*=-1;
      }
      if(by <= 16+3 && by >= 16-3){
        if(Math.abs(bx - opX) < 12) vy*=-1;
      }

      // 負け判定（ホストのみ行う）
      if(by > py+8){
        msg.textContent = "YOU LOSE";
        msg.style.opacity=1;
        setTimeout(()=>location.reload(),2000);
        return;
      }

      set(ballRef,{bx,by,vx,vy});
    }

    // ボール表示（全員）
    ball.style.left = bx+"vw";
    ball.style.top  = by+"vh";
  }

  requestAnimationFrame(gameLoop);
}
</script>

</body>
</html>