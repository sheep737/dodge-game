{"id":"67192","variant":"standard"}
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Duel Paddle Battle</title>

<style>
  html,body{
    height:100%;
    margin:0;
    padding:0;
    overflow:hidden;
    background:#111;
    touch-action:none;
  }

  /* ルーム入力画面 */
  #roomPanel{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.85);
    display:flex;
    flex-direction:column;
    justify-content:center;
    align-items:center;
    gap:1.2rem;
    z-index:10;
  }
  #roomPanel input{
    width:70vw;
    padding:0.6rem;
    font-size:5vw;
  }
  #roomPanel button{
    padding:0.6rem 1rem;
    font-size:5vw;
  }

  /* ステージ */
  #stage{
    position:fixed;
    inset:0;
    background:#222;
    overflow:hidden;
    display:none;
  }

  #hud{
    color:white;
    background:rgba(0,0,0,0.3);
    padding:0.6rem;
    position:absolute;
    left:3vw;
    top:3vw;
    font-size:4vw;
    border-radius:6px;
    z-index:20;
  }

  /* パドル */
  .paddle{
    position:absolute;
    width:22vw;
    height:3vh;
    max-height:30px;
    background:#4af;
    border-radius:4px;
  }
  #me{
    bottom:16vh; /* ← ← 修正済み: かなり上げた */
    left:50vw;
    transform:translateX(-50%);
  }
  #op{
    top:8vh;
    left:50vw;
    background:#f55;
    transform:translateX(-50%);
  }

  /* ボール */
  #ball{
    position:absolute;
    width:4vw;
    height:4vw;
    max-width:25px;
    max-height:25px;
    border-radius:50%;
    background:#fff;
    display:none;
    z-index:30;
  }

  /* ボタン（下の方にあったのを上へ） */
  #controls{
    position:absolute;
    bottom:3vh;      /* ← 上に移動 */
    height:12vh;     /* ← 小さめに調整 */
    width:100vw;
    display:flex;
    z-index:30;
  }
  .btn{
    flex:1;
    background:rgba(255,255,255,0.12);
    display:flex;
    align-items:center;
    justify-content:center;
    color:white;
    font-size:10vw;
  }
  .btn:active{
    background:rgba(255,255,255,0.3);
  }

  /* メッセージ */
  #msg{
    position:absolute;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    color:white;
    font-size:8vw;
    z-index:40;
    opacity:0;
    transition:opacity 0.4s;
  }
</style>
</head>
<body>

<!-- ルーム入力 -->
<div id="roomPanel">
  <div style="color:white;font-size:6vw;">Room ID を入力</div>
  <input id="roomInput" placeholder="例: paddle01" />
  <button id="joinBtn">Join</button>
  <button id="createBtn">Create Random</button>
  <div style="color:#ccc;font-size:4vw;">同じIDの相手と同期対戦</div>
</div>

<!-- ゲーム画面 -->
<div id="stage">
  <div id="hud">
    Room: <span id="roomLabel">-</span><br>
    Players: <span id="pcount">0</span>
  </div>

  <div id="msg"></div>

  <div id="me" class="paddle"></div>
  <div id="op" class="paddle"></div>
  <div id="ball"></div>

  <div id="controls">
    <div id="leftBtn" class="btn">◀</div>
    <div id="rightBtn" class="btn">▶</div>
  </div>
</div>

<!-- Firebase（あなたの設定をそのまま使用） -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set, push, onValue, remove, onDisconnect } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

/* あなたの Firebase 設定 */
const firebaseConfig = {
    apiKey: "AIzaSyAs8DqxHiRzveAMJ7j-UMBWKp6ztGF-hd8",
    authDomain: "ddgame-6f5f8.firebaseapp.com",
    databaseURL: "https://ddgame-6f5f8-default-rtdb.firebaseio.com",
    projectId: "ddgame-6f5f8",
    storageBucket: "ddgame-6f5f8.firebasestorage.app",
    messagingSenderId: "172945824128",
    appId: "1:172945824128:web:e3c7333928e1545aa1c965",
    measurementId: "G-FG0645HHZD"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* --- UI参照 --- */
const roomPanel = document.getElementById("roomPanel");
const roomInput = document.getElementById("roomInput");
const joinBtn = document.getElementById("joinBtn");
const createBtn = document.getElementById("createBtn");

const stage = document.getElementById("stage");
const me = document.getElementById("me");
const op = document.getElementById("op");
const ball = document.getElementById("ball");

const pcount = document.getElementById("pcount");
const roomLabel = document.getElementById("roomLabel");
const msg = document.getElementById("msg");

const leftBtn = document.getElementById("leftBtn");
const rightBtn = document.getElementById("rightBtn");

/* --- 状態 --- */
let roomId = "";
let myId = Math.random().toString(36).slice(2, 10);
let myX = 50;
let opX = 50;
let moveLeft = false;
let moveRight = false;
let gameStarted = false;

let vx = 0.4;
let vy = -0.5;
let bx = 50;
let by = 50;

/* --- ズーム禁止 --- */
["gesturestart","gesturechange","gestureend"].forEach(ev=>{
  document.addEventListener(ev,e=>e.preventDefault(),{passive:false});
});

/* --- Join処理 --- */
createBtn.onclick = () => {
  roomInput.value = "room-" + Math.floor(Math.random()*99999);
};
joinBtn.onclick = () => {
  const id = roomInput.value.trim();
  if(!id){ alert("Room ID を入力して"); return; }
  joinRoom(id);
};

function joinRoom(id){
  roomId = id;
  roomLabel.innerText = id;

  roomPanel.style.display = "none";
  stage.style.display = "block";

  const myRef = ref(db, `rooms/${roomId}/players/${myId}`);
  set(myRef, { x: myX });

  onDisconnect(myRef).remove();

  const playersRef = ref(db, `rooms/${roomId}/players`);
  onValue(playersRef, snap=>{
    const v = snap.val() || {};
    const keys = Object.keys(v);
    pcount.textContent = keys.length;

    const oppKey = keys.find(k => k !== myId);
    if(oppKey){
      opX = v[oppKey].x ?? 50;
    }
  });

  const startRef = ref(db, `rooms/${roomId}/start`);
  onValue(startRef, snap=>{
    if(snap.val() && !gameStarted){
      startGame();
    }
  });

  set(startRef, Date.now());
}

/* --- ゲーム開始 --- */
function startGame(){
  gameStarted = true;
  msg.textContent = "START!";
  msg.style.opacity = 1;
  setTimeout(()=> msg.style.opacity = 0, 1200);

  bx = 50;
  by = 50;
  ball.style.display = "block";

  gameLoop();
}

/* --- 操作 --- */
leftBtn.ontouchstart = ()=> moveLeft = true;
leftBtn.ontouchend   = ()=> moveLeft = false;
rightBtn.ontouchstart= ()=> moveRight = true;
rightBtn.ontouchend  = ()=> moveRight = false;

/* --- メインループ --- */
function gameLoop(){
  if(moveLeft) myX -= 1.2;
  if(moveRight) myX += 1.2;
  myX = Math.max(5, Math.min(95, myX));
  me.style.left = myX + "vw";

  set(ref(db, `rooms/${roomId}/players/${myId}`), { x: myX });

  op.style.left = opX + "vw";

  bx += vx;
  by += vy;

  if(bx < 0 || bx > 100) vx *= -1;

  if(by < 0){
    vy *= -1;
  }

  if(by > 88 && by < 92){
    if(Math.abs(bx - myX) < 12){
      vy *= -1;
    } else if(by > 95){
      msg.textContent = "YOU LOSE";
      msg.style.opacity = 1;
      setTimeout(()=>location.reload(), 2000);
      return;
    }
  }

  ball.style.left = bx + "vw";
  ball.style.top = by + "vh";

  requestAnimationFrame(gameLoop);
}
</script>
</body>
</html>