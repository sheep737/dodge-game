<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>対戦ブロック崩し</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">

<style>
body {
    margin: 0;
    background: #111;
    overflow: hidden;
    user-select: none;
    touch-action: none;
}

#game {
    position: absolute;
    width: 100vw;
    height: 100vh;
    background: #222;
}

.paddle {
    position: absolute;
    width: 20vw;
    height: 3vh;
    background: #4af;
}

#me { bottom: 5vh; }
#op { top: 5vh; background: #f55; }

#ball {
    position: absolute;
    width: 4vw;
    height: 4vw;
    max-width: 25px;
    max-height: 25px;
    border-radius: 50%;
    background: #fff;
    display: none;
}

/* UI */
#ui {
    position: absolute;
    top: 1vh;
    left: 2vw;
    color: #fff;
    font-size: 4vw;
    z-index: 20;
}

#startBtn {
    font-size: 5vw;
    padding: 1vw 3vw;
    margin-top: 1vw;
}

#controls {
    position: absolute;
    bottom: 0;
    height: 15vh;
    width: 100vw;
    display: flex;
}
.btn {
    flex: 1;
    background: rgba(255,255,255,0.1);
    color: white;
    font-size: 10vw;
    display: flex;
    align-items: center;
    justify-content: center;
}
.btn:active { background: rgba(255,255,255,0.3); }
</style>
</head>
<body>

<div id="game">
    <div id="ui">
        Room: <span id="roomText"></span><br>
        Players: <span id="pCount">0</span><br>
        <button id="startBtn" disabled>Start</button>
    </div>

    <div id="me" class="paddle"></div>
    <div id="op" class="paddle"></div>
    <div id="ball"></div>

    <div id="controls">
        <div id="left"  class="btn">◀</div>
        <div id="right" class="btn">▶</div>
    </div>
</div>

<script type="module">
/* ----- Firebase ----- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set, onValue, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

/* ---- ここをあなたの Firebase に変更 ---- */
const firebaseConfig = {
    apiKey: "AIzaSyAs8DqxHiRzveAMJ7j-UMBWKp6ztGF-hd8",
    authDomain: "ddgame-6f5f8.firebaseapp.com",
    databaseURL: "https://ddgame-6f5f8-default-rtdb.firebaseio.com",
    projectId: "ddgame-6f5f8",
    storageBucket: "ddgame-6f5f8.firebasestorage.app",
    messagingSenderId: "172945824128",
    appId: "1:172945824128:web:e3c7333928e1545aa1c965",
    measurementId: "G-FG0645HHZD"
};
/* -------------------------------------- */

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* ----- ゲーム変数 ----- */
const me = document.getElementById("me");
const op = document.getElementById("op");
const ball = document.getElementById("ball");

let roomId = prompt("RoomID?") || "test";
document.getElementById("roomText").innerText = roomId;

let myId = Math.random().toString(36).slice(2,10);
let myX = 40;
let opX = 40;

let ballX = 45;
let ballY = 45;
let vx = 1;   // ボール速度
let vy = 1.5;

let gameStarted = false;

/* ----- Firebase参照 ----- */
const playersRef = ref(db, roomId + "/players");
const ballRef = ref(db, roomId + "/ball");

/* ----- プレイヤー登録 ----- */
const myRef = push(playersRef);
set(myRef, { id: myId, x: myX });
onValue(playersRef, snap => {
    const val = snap.val() || {};
    const keys = Object.keys(val);

    document.getElementById("pCount").innerText = keys.length;

    // 相手の位置更新
    for (const k of keys) {
        if (val[k].id !== myId) opX = val[k].x;
    }

    // 2人揃ったら Start を押せる
    document.getElementById("startBtn").disabled = (keys.length < 2);
});

/* ----- 操作 ----- */
let leftDown = false, rightDown = false;

document.getElementById("left").addEventListener("touchstart", ()=> leftDown = true);
document.getElementById("left").addEventListener("touchend", ()=> leftDown = false);
document.getElementById("right").addEventListener("touchstart", ()=> rightDown = true);
document.getElementById("right").addEventListener("touchend", ()=> rightDown = false);

/* ----- Start ----- */
document.getElementById("startBtn").addEventListener("click", ()=>{
    set(ballRef, { start: true });
});

/* ----- ボール同期 ----- */
onValue(ballRef, snap => {
    const v = snap.val();
    if (!v) return;

    if (v.start && !gameStarted) {
        gameStarted = true;
        ball.style.display = "block";
    }
});

/* ----- メインループ ----- */
function loop() {
    if (gameStarted) {

        /* パドルの移動 */
        if (leftDown)  myX -= 1.5;
        if (rightDown) myX += 1.5;
        myX = Math.max(0, Math.min(80, myX));

        me.style.left = myX + "vw";
        op.style.left = opX + "vw";

        // Firebaseへ送信
        set(myRef, { id: myId, x: myX });

        /* ボールの移動 */
        ballX += vx;
        ballY += vy;

        ball.style.left = ballX + "vw";
        ball.style.top  = ballY + "vh";

        // 壁反射
        if (ballX <= 0 || ballX >= 96) vx *= -1;

        // 下のプレイヤーに当たる
        if (ballY >= 83) {
            if (ballX + 4 >= myX && ballX <= myX + 20) {
                vy *= -1;
            } else {
                alert("あなたの負け！");
                location.reload();
            }
        }

        // 上のプレイヤーに当たる
        if (ballY <= 8) {
            if (ballX + 4 >= opX && ballX <= opX + 20) {
                vy *= -1;
            } else {
                alert("あなたの勝ち！");
                location.reload();
            }
        }
    }

    requestAnimationFrame(loop);
}
loop();

</script>
</body>
</html>