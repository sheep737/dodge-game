<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Realtime Message Display</title>
<style>
  html,body{
    height:100%;
    margin:0;
    padding:0;
    background:#111;
    -webkit-user-select:none;
    user-select:none;
    overflow:hidden;
    font-family: system-ui, -apple-system, "Helvetica Neue", Arial;
  }

  /* ルーム入力画面（最初表示） */
  #roomPanel {
    position:fixed;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    background:rgba(0,0,0,0.85);
    z-index:30;
    flex-direction:column;
    gap:1.5rem;
  }
  #roomPanel input{
    font-size:5vw;
    padding:0.8rem 1rem;
    width:70vw;
    box-sizing:border-box;
  }
  #roomPanel button{
    font-size:5vw;
    padding:0.6rem 1.2rem;
  }

  /* メイン画面 */
  #app {
    width:100%;
    height:100%;
    position:relative;
    display:flex;
    flex-direction:column;
  }

  #topBar {
    position:absolute;
    top:1vh;
    left:1vw;
    z-index:20;
    color:#fff;
    font-size:4vw;
    background:rgba(0,0,0,0.3);
    padding:0.6vh 1vw;
    border-radius:8px;
  }

  /* 表示領域（相手に見せる大きい文字） */
  #displayArea {
    flex:1;
    display:flex;
    align-items:center;
    justify-content:center;
    color:#fff;
    padding:4vw;
    text-align:center;
  }

  #displayText {
    font-size:10vw;            /* 大きく表示 */
    line-height:1.0;
    max-width:96%;
    word-wrap:break-word;
  }

  /* 入力領域（下） */
  #inputBar {
    position:absolute;
    bottom:0;
    left:0;
    width:100%;
    display:flex;
    gap:0.6rem;
    padding:3vw;
    box-sizing:border-box;
    background: linear-gradient(0deg, rgba(0,0,0,0.5), transparent);
  }
  #messageInput{
    flex:1;
    font-size:5vw;
    padding:0.8rem 1rem;
    border-radius:8px;
    border: none;
    outline: none;
    box-sizing:border-box;
  }
  #sendBtn{
    font-size:5vw;
    padding:0.6rem 1rem;
  }

  /* small devices tweak */
  @media (min-width:600px){
    #displayText { font-size:48px; }
    #roomPanel input, #roomPanel button { font-size:18px; }
    #topBar { font-size:16px; }
  }
</style>
</head>
<body>

<!-- ルーム入力 -->
<div id="roomPanel">
  <div style="color:#fff; font-size:6vw;">Room ID を入力して Join</div>
  <input id="roomInput" placeholder="例: room123" />
  <div>
    <button id="joinBtn">Join</button>
    <button id="newBtn">Create Random</button>
  </div>
  <div style="color:#bbb; font-size:3.8vw;">同じ Room ID を使った相手の画面に表示されます</div>
</div>

<!-- メインアプリ -->
<div id="app" style="display:none;">
  <div id="topBar">
    Room: <span id="roomLabel">—</span>
    &nbsp; • &nbsp;
    Players: <span id="playerCount">0</span>
  </div>

  <div id="displayArea">
    <div id="displayText">待機中…</div>
  </div>

  <div id="inputBar">
    <input id="messageInput" placeholder="ここに送る文章を入力" />
    <button id="sendBtn">Send</button>
  </div>
</div>

<!-- Firebase (モジュール版) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getDatabase, ref, set, onValue, push, onDisconnect } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

  // ===== ここをあなたのFirebase設定に差し替えてください =====
  const firebaseConfig = {
    apiKey: "AIzaSyAs8DqxHiRzveAMJ7j-UMBWKp6ztGF-hd8",
    authDomain: "ddgame-6f5f8.firebaseapp.com",
    databaseURL: "https://ddgame-6f5f8-default-rtdb.firebaseio.com",
    projectId: "ddgame-6f5f8",
    storageBucket: "ddgame-6f5f8.firebasestorage.app",
    messagingSenderId: "172945824128",
    appId: "1:172945824128:web:e3c7333928e1545aa1c965",
    measurementId: "G-FG0645HHZD"
  };
  // ==========================================================

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // UI elements
  const roomPanel = document.getElementById('roomPanel');
  const roomInput = document.getElementById('roomInput');
  const joinBtn = document.getElementById('joinBtn');
  const newBtn = document.getElementById('newBtn');

  const appRoot = document.getElementById('app');
  const roomLabel = document.getElementById('roomLabel');
  const playerCount = document.getElementById('playerCount');
  const displayText = document.getElementById('displayText');
  const messageInput = document.getElementById('messageInput');
  const sendBtn = document.getElementById('sendBtn');

  // small id for this client
  function genId(n=6){
    const r = "abcdefghijklmnopqrstuvwxyz0123456789";
    let s="";
    for(let i=0;i<n;i++) s+=r[Math.floor(Math.random()*r.length)];
    return s;
  }
  const clientId = genId(8);

  let roomId = null;
  let playersRef = null;
  let messageRef = null;
  let myPlayerRef = null;

  // helper: show app after join
  function enterRoom(id){
    roomId = id;
    roomLabel.innerText = id;
    roomPanel.style.display = 'none';
    appRoot.style.display = 'block';

    // refs
    playersRef = ref(db, `rooms/${roomId}/players`);
    messageRef = ref(db, `rooms/${roomId}/message`);

    // register player (push)
    myPlayerRef = push(playersRef);
    set(myPlayerRef, { id: clientId, ts: Date.now() });
    onDisconnect(myPlayerRef).remove();

    // monitor player count
    onValue(playersRef, snap => {
      const o = snap.val() || {};
      playerCount.innerText = Object.keys(o).length;
    });

    // listen for message changes (real-time)
    onValue(messageRef, snap => {
      const data = snap.val();
      if(!data || !data.text) {
        displayText.innerText = "待機中…";
        return;
      }
      // 表示
      const who = data.from || 'Anonymous';
      const t = new Date(data.t || Date.now());
      displayText.innerText = data.text;

      // optional: small subtle flash animation
      displayText.style.transition = 'none';
      displayText.style.opacity = '0.2';
      requestAnimationFrame(()=>{
        displayText.style.transition = 'opacity 300ms';
        displayText.style.opacity = '1';
      });
    });
  }

  // join button
  joinBtn.addEventListener('click', ()=>{
    const id = (roomInput.value||'').trim();
    if(!id){ alert('Room ID を入力してください'); return; }
    enterRoom(id);
  });

  // create random room
  newBtn.addEventListener('click', ()=>{
    const id = 'room-' + Math.floor(Math.random()*100000);
    roomInput.value = id;
    enterRoom(id);
  });

  // send message: set the message node (overwrite)
  sendBtn.addEventListener('click', ()=>{
    const text = (messageInput.value||'').trim();
    if(!text) return;
    if(!roomId){ alert('先に Room に入ってください'); return; }
    set(messageRef, {
      text: text,
      from: clientId,
      t: Date.now()
    }).catch(err=>{
      console.error('send error', err);
      alert('送信エラー: ' + err.message);
    });

    // clear input optionally
    messageInput.value = '';
  });

  // enter by pressing Enter key on input
  messageInput.addEventListener('keydown', e=>{
    if(e.key === 'Enter'){
      sendBtn.click();
      e.preventDefault();
    }
  });

  // prevent pinch/doubletap zoom and fix height (iPhone fixes)
  document.addEventListener('gesturestart', e=>e.preventDefault(), {passive:false});
  let lastTouch = 0;
  document.addEventListener('touchend', e=>{
    const now = Date.now();
    if(now - lastTouch < 350) e.preventDefault();
    lastTouch = now;
  }, {passive:false});
  document.addEventListener('touchstart', e=>{
    if(e.touches && e.touches.length > 1) e.preventDefault();
  }, {passive:false});
  // apply true height to avoid 100vh issues
  function fixHeight(){
    document.body.style.height = window.innerHeight + 'px';
  }
  window.addEventListener('resize', fixHeight);
  window.addEventListener('orientationchange', fixHeight);
  fixHeight();

</script>
</body>
</html>