<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Paddle Duel v1.0</title>

<style>
  html,body{
    margin:0;padding:0;height:100%;overflow:hidden;
    background:#111;font-family:system-ui;
  }

  /* 画面 */
  #stage{
    position:fixed;left:0;top:0;width:100vw;height:100vh;
    background:#222;display:none;overflow:hidden;
  }

  /* Room UI */
  #roomPanel{
    position:fixed;inset:0;background:#000c;
    display:flex;flex-direction:column;
    align-items:center;justify-content:center;
    gap:2rem;z-index:50;
  }
  #roomPanel input{
    width:70vw;font-size:6vw;padding:1rem;
  }
  #roomPanel button{
    font-size:6vw;padding:1rem 2rem;
  }

  /* HUD */
  #hud{
    position:fixed;left:3vw;top:2vw;font-size:4vw;
    color:#fff;z-index:30;
  }
  #ver{
    position:fixed;right:3vw;top:2vw;font-size:4vw;
    color:#fff;z-index:30;
  }

  /* パドル */
  .paddle{
    position:absolute;width:22vw;height:3vh;
    background:#4af;border-radius:8px;
  }
  #enemyPaddle{background:#f55;}

  /* ボール */
  #ball{
    position:absolute;width:4vw;height:4vw;border-radius:50%;
    background:#ffd;display:none;
  }

  /* メッセージ */
  #msg{
    position:fixed;inset:0;display:flex;
    align-items:center;justify-content:center;
    color:#fff;font-size:10vw;
    z-index:40;pointer-events:none;
    opacity:0;transition:opacity .3s;
  }

  /* ボタン（安全領域） */
  #controls{
    position:fixed;left:0;right:0;
    bottom:env(safe-area-inset-bottom, 20px);
    display:flex;justify-content:center;
    gap:15vw;z-index:200;padding-bottom:2vh;
  }
  .btn{
    background:#333;color:#fff;border:2px solid #fff;
    border-radius:10px;font-size:8vw;padding:1rem 2rem;
    user-select:none;touch-action:manipulation;
  }

  /* Start / Leave */
  #topControls{
    position:fixed;right:3vw;bottom:20vh;z-index:200;
    display:flex;flex-direction:column;gap:1rem;
  }
  .tbtn{
    background:#555;color:#fff;border:2px solid #fff;
    padding:.8rem 1.4rem;font-size:5vw;border-radius:8px;
  }
</style>
</head>
<body>

<div id="roomPanel">
  <div style="color:white;font-size:7vw;">Room ID</div>
  <input id="roomInput" placeholder="abc123">
  <button id="joinBtn">Join</button>
</div>

<div id="stage">
  <div id="hud">Players: <span id="pcount">1</span></div>
  <div id="ver">v1.0</div>
  <div id="msg"></div>

  <div id="myPaddle" class="paddle"></div>
  <div id="enemyPaddle" class="paddle"></div>
  <div id="ball"></div>

  <div id="controls">
    <div id="leftBtn" class="btn">←</div>
    <div id="rightBtn" class="btn">→</div>
  </div>

  <div id="topControls">
    <div id="startBtn" class="tbtn">Start</div>
    <div id="leaveBtn" class="tbtn">Leave</div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set, push, onValue, remove, onDisconnect } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

/* ★★★ Firebase をあなたのものに書き換え ★★★ */
const firebaseConfig = {
    apiKey: "AIzaSyAs8DqxHiRzveAMJ7j-UMBWKp6ztGF-hd8",
    authDomain: "ddgame-6f5f8.firebaseapp.com",
    databaseURL: "https://ddgame-6f5f8-default-rtdb.firebaseio.com",
    projectId: "ddgame-6f5f8",
    storageBucket: "ddgame-6f5f8.firebasestorage.app",
    messagingSenderId: "172945824128",
    appId: "1:172945824128:web:e3c7333928e1545aa1c965",
    measurementId: "G-FG0645HHZD"
};
/* ★★★ ↑ここだけ変更 ★★★ */

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* UI */
const roomPanel = document.getElementById("roomPanel");
const stage = document.getElementById("stage");
const msg = document.getElementById("msg");
const pcountEl = document.getElementById("pcount");

const myP = document.getElementById("myPaddle");
const opP = document.getElementById("enemyPaddle");
const ball = document.getElementById("ball");

const startBtn = document.getElementById("startBtn");
const leaveBtn = document.getElementById("leaveBtn");

const leftBtn = document.getElementById("leftBtn");
const rightBtn = document.getElementById("rightBtn");

let roomId=null;
let myId = Math.random().toString(36).slice(2,10);

let playersRef, ballRef, startRef, meRef;
let enemy = null;
let gameStarted=false;

/* パドル位置 */
let myX=40;           // vw
let enemyX=40;
let ballX=50, ballY=50, vx=0, vy=0;

let moveLeft=false, moveRight=false;

/* パドル操作（pointer 取りこぼし無し） */
function bind(btn, on, off){
  btn.addEventListener("pointerdown", e=>{e.preventDefault();on();});
  btn.addEventListener("pointerup", off);
  btn.addEventListener("pointerleave", off);
  btn.addEventListener("pointercancel", off);
}
bind(leftBtn, ()=>moveLeft=true, ()=>moveLeft=false);
bind(rightBtn, ()=>moveRight=true, ()=>moveRight=false);

/* Join */
document.getElementById("joinBtn").onclick = ()=>{
  const id = document.getElementById("roomInput").value.trim();
  if(!id){ alert("Room ID 入力"); return; }
  joinRoom(id);
};

function joinRoom(id){
  roomId=id;
  roomPanel.style.display="none";
  stage.style.display="block";

  playersRef = ref(db, `rooms/${roomId}/players`);
  ballRef = ref(db, `rooms/${roomId}/ball`);
  startRef = ref(db, `rooms/${roomId}/start`);

  meRef = ref(db, `rooms/${roomId}/players/${myId}`);
  set(meRef,{id:myId,x:myX});
  onDisconnect(meRef).remove();

  onValue(playersRef, snap=>{
    const v=snap.val()||{};
    const keys=Object.keys(v);
    pcountEl.innerText=keys.length;

    enemy = keys.find(k=>k!==myId);
    if(enemy && v[enemy]){
      enemyX = v[enemy].x;
    }
  });

  onValue(ballRef, snap=>{
    const v=snap.val();
    if(!v) return;
    ballX=v.x; ballY=v.y;
  });

  onValue(startRef, snap=>{
    if(snap.val() && !gameStarted){
      beginGame();
    }
  });
}

/* Start */
startBtn.onclick = ()=>{
  if(!roomId) return;
  set(startRef,{go:true});
};

/* Leave */
leaveBtn.onclick = ()=>{
  if(meRef) remove(meRef);
  location.reload();
};

/* ゲーム開始 */
function beginGame(){
  gameStarted=true;
  announce("Start!");

  /* 最初のボール速度 */
  vx = (Math.random()*0.4+0.3) * (Math.random()<0.5?-1:1);
  vy = 0.55;   // ← 少し遅め

  ball.style.display="block";

  loop();
}

/* メッセージ */
function announce(t){
  msg.innerText=t;
  msg.style.opacity=1;
  setTimeout(()=>msg.style.opacity=0,1500);
}

/* メインループ */
function loop(){
  if(!gameStarted){ requestAnimationFrame(loop); return; }

  /* パドル操作 */
  if(moveLeft) myX -= 0.8;
  if(moveRight) myX += 0.8;

  myX = Math.max(0, Math.min(78, myX));

  /* DBに自分のパドル反映 */
  set(meRef,{id:myId,x:myX});

  /* 敵パドルの反映 */
  if(enemy!==null) opP.style.left = enemyX+"vw";

  /* ボール更新（ホストのみ判定） */
  if(myId < enemy){  // ← 文字列比較で安定ホスト
    ballX += vx;
    ballY += vy;

    /* 左右反射 */
    if(ballX < 0 || ballX > 96) vx *= -1;

    /* 上側（相手勝ち） */
    if(ballY < 0){
      announce("You Win!");
      setTimeout(()=>location.reload(),1500);
    }

    /* 下側（自分負け） */
    if(ballY > 96){
      announce("You Lose");
      setTimeout(()=>location.reload(),1500);
    }

    /* パドル衝突（自分） */
    if(ballY>86 && ballY<90){
      if(ballX > myX-2 && ballX < myX+22){
        vy *= -1;
      }
    }

    /* パドル衝突（相手） */
    if(ballY<10){
      if(ballX > enemyX-2 && ballX < enemyX+22){
        vy *= -1;
      }
    }

    /* DBへボール反映 */
    set(ballRef,{x:ballX,y:ballY});
  }

  /* 画面反映 */
  myP.style.left = myX+"vw";
  ball.style.left = ballX+"vw";
  ball.style.top = ballY+"vh";

  requestAnimationFrame(loop);
}
</script>
</body>
</html>