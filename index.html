<!DOCTYPE html>
<html lang="ja">
<head> <meta charset="UTF-8"> </head>
<body>
  <!-- ■■■■■■■■■■■■■■■■■■■■■■■■■■■ -->
  <!-- ■    画面構成              ■ -->
  <!-- ■■■■■■■■■■■■■■■■■■■■■■■■■■■ -->
  <button id="draw">カードを引く【Ver：4】</button>
  <div id="deck"></div>
  <div id="hand"></div>

  <script type="module">
    // ■■■■■■■■■■■■■■■■■■■■■■■■■■■
    // ■    Firebase設定         ■
    // ■■■■■■■■■■■■■■■■■■■■■■■■■■■
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
    import {
      getDatabase,
      ref,
      get,
      set,
      update,
      onValue
    } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-database.js";

    const firebaseConfig = {
        apiKey:            "AIzaSyAs8DqxHiRzveAMJ7j-UMBWKp6ztGF-hd8",
        authDomain:        "ddgame-6f5f8.firebaseapp.com",
        databaseURL:       "https://ddgame-6f5f8-default-rtdb.firebaseio.com",
        projectId:         "ddgame-6f5f8",
        storageBucket:     "ddgame-6f5f8.firebasestorage.app",
        messagingSenderId: "172945824128",
        appId:             "1:172945824128:web:e3c7333928e1545aa1c965",
        measurementId:     "G-FG0645HHZD"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    // ■■■■■■■■■■■■■■■■■■■■■■■■■■■
    // ■    変数・定数            ■
    // ■■■■■■■■■■■■■■■■■■■■■■■■■■■
    const roomId   = "room1";
    const playerId = "playerA"; // ← playerB に変えると相手側になる

    // URLからプレイヤーIDを取得
    const pv_urlParams = new URLSearchParams(window.location.search);
    const pv_playerId = pv_urlParams.get("player") || "playerA"; // デフォルト playerA

    const roomRef = ref(db, `rooms/${roomId}`);
    const pv_db_deck = ref(db, `rooms/${roomId}/deck`);
    const pv_db_hand = ref(db, `rooms/${roomId}/hands/${pv_playerId}`);

    // ■■■■■■■■■■■■■■■■■■■■■■■■■■■
    // ■    リアルタイム表示      ■
    // ■■■■■■■■■■■■■■■■■■■■■■■■■■■
    onValue(pv_db_deck, (lv_snapshot_deck) => {
      const lv_deck = lv_snapshot_deck.val() || [];
      document.getElementById("deck").innerHTML = lv_deck.join(", ");
    });

    onValue(pv_db_hand, (lv_snapshot_hand) => {
      const lv_hand = lv_snapshot_hand.val() || [];
      document.getElementById("hand").innerHTML = lv_hand.join(", ");
    });

    // ■■■■■■■■■■■■■■■■■■■■■■■■■■■
    // ■    ボタン動作            ■
    // ■■■■■■■■■■■■■■■■■■■■■■■■■■■
    document.getElementById("draw").addEventListener("click", drawCard);
    
    // ■■■■■■■■■■■■■■■■■■■■■■■■■■■
    // ■    関数                 ■
    // ■■■■■■■■■■■■■■■■■■■■■■■■■■■
    // ●--------カードを引く--------●
    async function drawCard() {
      const deckSnap = await get(pv_db_deck);
      const handSnap = await get(pv_db_hand);

      let deck = deckSnap.val() || [];
      let hand = handSnap.val() || [];

      if (deck.length === 0) {
        alert("山札がありません");
        return;
      }

      const card = deck.shift(); // 山札の一番上を引く
      hand.push(card);           // 手札に追加

      // --- データ更新（同時更新対策で update を使う） ---
      await update(roomRef, {
        deck: deck,
        [`hands/${pv_playerId}`]: hand
      });
    }
    
  </script>
</body>
</html>
