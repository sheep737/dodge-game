<!DOCTYPE html>
<html lang="ja">
<head> 
  <meta name="viewport" content="width=device-width, initial-scale=1" charset="UTF-8"> 
  <style>
    #deckImage {
      width: 80px;
      height: 120px;
      border-radius: 10px;
      background: repeating-linear-gradient(
          45deg,
          #2d2d7f,
          #2d2d7f 10px,
          #1a1a4f 10px,
          #1a1a4f 20px
        );
      border: 3px solid #000;
      box-shadow: 0 6px 8px rgba(0,0,0,0.4);
      margin-bottom: 5px;
      transition: transform 0.2s, opacity 0.3s;
    }
    
    /* マウスで浮く演出 */
    #deckImage:hover {
      transform: translateY(-5px);
    }
  
    #deckCount {
      margin-top: 5px;
      font-size: 16px;
      font-weight: bold;
    }
    
    #hand {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 20px;
    }
    
    .cardButton {
      width: 80px;
      height: 120px;
      margin: 5px;
      border-radius: 10px;
      border: 2px solid #000;
      background: repeating-linear-gradient(
          45deg,
          #ffffff,
          #ffffff 10px,
          #e5e5e5 10px,
          #e5e5e5 20px
      );
      font-size: 24px;
      font-weight: bold;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: 8px;
      align-items: center;
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
      cursor: pointer;
      transition: transform 0.15s;
    }

    .cardButton div:nth-child(1) {
      font-size: 20px;
      font-weight: bold;
    }
    
    .cardButton div:nth-child(2) {
      font-size: 12px;
    }
    
    .cardButton:hover {
      transform: translateY(-4px);
    }

    #topArea {
      display: flex;
      align-items: center;
      gap: 40px; /* デッキと場の間の余白 */
      margin-bottom: 20px;
    }
	  
	#shopList {
	  display: grid;
	  grid-template-columns: repeat(4, 1fr); /* PCは4枚 */
	  gap: 12px;
	  margin-top: 20px;
	  justify-items: center;
	}

	/* ===== Shopカード専用 ===== */
	#shopList .cardName {
	  font-size: 14px;
	}
	
	#shopList .cardText {
	  font-size: 12px;
	  line-height: 1.2;
	}

	#shopControl {
	  margin-top: 10px;
	  font-size: 16px;
	}

	.cardName {
	  font-size: 16px;   /* ← 少し小さく */
	  font-weight: bold;
	  line-height: 1.1;
	  text-align: center;
	}

	.fieldName {
	  font-size: 14px;   /* ← 好みで 13〜15px */
	}

	@media (max-width: 600px) {
    
      #topArea {
        flex-direction: row;   /* ← 横並びのまま */
        justify-content: center;
        gap: 20px;
        width: 100%;
      }
    
      #deckImage {
        width: 30vw;
        height: 45vw;
      }
    
      .cardButton {
        width: 30vw;
        height: 45vw;
        padding: 5px;
        margin: 4px;
		flex-shrink: 0;
      }
      
      .cardButton .cardName {
        font-size: 3vw;
      }
    
      .cardButton .cardText {
        font-size: 3vw;
      }
      
		/* 通常カード（手札・場）だけ */
		#hand .cardName,
		#field .cardName {
		  font-size: 20px;
		}
    
      .cardButton div:nth-child(2) {
        font-size: 10px;
      }
    
      #hand {
		  display: flex;
		  flex-wrap: nowrap;      /* 折り返さない */
		  overflow-x: auto;       /* 横スクロール */
		  gap: 8px;
		  padding-bottom: 10px;
		  -webkit-overflow-scrolling: touch; /* iOSなめらか */
		  width: 100%;
      }
      
      #field {
        display: flex;
        justify-content: center;
        width: 100%;
      }
    
      /* デッキも中央寄せ */
      #deck {
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      
      #reset {
        font-size: 14px;
        padding: 6px 10px;
      }
    
      body {
        zoom: 1.0; /* 拡大縮小の誤差防止 */
        padding: 10px;
        padding-top: 5px;
		overflow-x: hidden;
      }

      #deckImage:active,
      .cardButton:active {
        transform: translateY(2px) scale(0.97);
        filter: brightness(0.95);
      }

      #shopList {
        grid-template-columns: repeat(4, 1fr);
      }

      /* ★ Shopカードはvwを使わない */
      #shopList .cardName {
        font-size: 14px;
      }
    
      #shopList .cardText {
        font-size: 11px;
      }

    }

	/* ===== iPad横持ち：Shopカード ===== */
	@media (min-width: 768px) and (max-width: 1366px) {
	
	  #shopList .cardName {
	    font-size: 13px;
	  }
	
	  #shopList .cardText {
	    font-size: 11px;
	  }
	
	}

  </style>
</head>
<body>
  <!-- ■■■■■■■■■■■■■■■■■■■■■■■■■■■ -->
  <!-- ■    画面構成              ■ -->
  <!-- ■■■■■■■■■■■■■■■■■■■■■■■■■■■ -->
  <div>
    <button id="reset">リセット【Ver：44】</button>
	<button id="leaveRoom">退室</button>
    <button id="shuffleDeck">シャッフル</button>
	<button id="returnToDeck">場を山札に戻す</button>
  </div>
  <div id="topArea">
    <div id="deck">
      <div id="deckImage"></div>
      <div id="deckCount"></div>
    </div>
  
    <div id="field"></div>
  </div>
  <div id="hand"></div>
	<div id="shopControl">
	  追加先：
	  <select id="targetPlayerSelect"></select>
	</div>
	<div id="shopList"></div>
	<div id="playerList"></div>

  <script type="module">
    // ■■■■■■■■■■■■■■■■■■■■■■■■■■■
    // ■    Firebase設定         ■
    // ■■■■■■■■■■■■■■■■■■■■■■■■■■■
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
    import {
      getDatabase,
      ref,
      get,
      set,
      update,
      onValue
    } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-database.js";

    const firebaseConfig = {
        apiKey:            "AIzaSyAs8DqxHiRzveAMJ7j-UMBWKp6ztGF-hd8",
        authDomain:        "ddgame-6f5f8.firebaseapp.com",
        databaseURL:       "https://ddgame-6f5f8-default-rtdb.firebaseio.com",
        projectId:         "ddgame-6f5f8",
        storageBucket:     "ddgame-6f5f8.firebasestorage.app",
        messagingSenderId: "172945824128",
        appId:             "1:172945824128:web:e3c7333928e1545aa1c965",
        measurementId:     "G-FG0645HHZD"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    // ■■■■■■■■■■■■■■■■■■■■■■■■■■■
    // ■    変数・定数            ■
    // ■■■■■■■■■■■■■■■■■■■■■■■■■■■
    const roomId   = "room1";
    const initialDeck = [
      { name: "A_銅貨", cost: 0, text: "＋１コイン" },
      { name: "B_銅貨", cost: 0, text: "＋１コイン" },
      { name: "C_銅貨", cost: 0, text: "＋１コイン" },
      { name: "D_銅貨", cost: 0, text: "＋１コイン" },
      { name: "E_銅貨", cost: 0, text: "＋１コイン" },
      { name: "F_銅貨", cost: 0, text: "＋１コイン" },
      { name: "G_銅貨", cost: 0, text: "＋１コイン" },
      { name: "H_屋敷", cost: 2, text: "勝利点１" },
      { name: "I_屋敷", cost: 2, text: "勝利点１" },
      { name: "J_屋敷", cost: 2, text: "勝利点１" },
    ];
		  
	const shopDeck = [
	  { name: "工房", cost: 3, text: "コスト１以下のカードを１枚獲得する" },
	  { name: "地下貯蔵庫", cost: 2, text: "＋１アクション。手札から好きな枚数のカードを捨て、その枚数分引く" },
	  { name: "鉱山", cost: 5, text: "財宝を破棄し、＋３コストまでの財宝を獲得する" },
	  { name: "村", cost: 3, text: "＋１カード。\n＋２アクション" },
	  { name: "鍛冶屋", cost: 4, text: "＋３カードを引く" },
	  { name: "改築", cost: 4, text: "カードを破棄し、＋２コストまで獲得" },
	  { name: "民兵", cost: 4, text: "＋２コイン。他のプレイヤーは手札３枚にする" },
	  { name: "市場", cost: 5, text: "＋１カード。＋１アクション。＋１購入" },
	  { name: "商人", cost: 3, text: "銀貨を引くと＋１コイン" },
	  { name: "堀", cost: 2, text: "アタック時に公開すると無効化" },
	  { name: "銅貨", cost: 0, text: "＋１コイン" },
	  { name: "銀貨", cost: 3, text: "＋２コイン" },
	  { name: "金貨", cost: 6, text: "＋３コイン" },
	  { name: "屋敷", cost: 2, text: "勝利点１" },
	  { name: "公領", cost: 5, text: "勝利点３" }
	  // ,{ name: "属州", cost: 8, text: "勝利点６" }
	];
	  
    // URLからプレイヤーIDを取得
    const pv_urlParams = new URLSearchParams(window.location.search);
    const pv_playerId = pv_urlParams.get("player") || "playerA"; // デフォルト playerA
	const isShop = pv_playerId === "shop";
	const targetPlayer = pv_urlParams.get("target") || "playerA";

	const roomRef     = ref(db, `rooms/${roomId}`);
    const pv_db_deck = ref(db, `rooms/${roomId}/decks/${pv_playerId}`);
    const pv_db_hand  = ref(db, `rooms/${roomId}/hands/${pv_playerId}`);
    const pv_db_field_all = ref(db, `rooms/${roomId}/field`);
	const pv_db_shopDeck = ref(db, `rooms/${roomId}/shopDeck`);
	const pv_db_field = ref(db, `rooms/${roomId}/fields/${pv_playerId}`);
	  
    // ■■■■■■■■■■■■■■■■■■■■■■■■■■■
    // ■    リアルタイム表示      ■
    // ■■■■■■■■■■■■■■■■■■■■■■■■■■■
    // ●--------描画：デッキ--------●
	if (!isShop) {
	  onValue(pv_db_deck, (snap) => {
	    const deck = snap.val() || [];
	    document.getElementById("deckCount").innerText = `残り：${deck.length}枚`;
	    document.getElementById("deckImage").style.opacity =
	      deck.length === 0 ? "0.3" : "1";
	  });
	}
	  
    // ●--------描画：手札--------●
    onValue(pv_db_hand, (lv_snapshot_hand) => {
	  if (isShop) return;
      const lv_hand = lv_snapshot_hand.val() || [];
      const handDiv = document.getElementById("hand");
      handDiv.innerHTML = "";
    
      lv_hand.forEach((card, index) => {
        const btn = document.createElement("div");
        btn.className = "cardButton";
        btn.innerHTML = `
          <div class="cardName">${card.name}</div>
          <div class="cardText">${card.text}</div>
        `;
        btn.onclick = () => playCard(index);  // カードを場に出す
      
        handDiv.appendChild(btn);
      });
    });

    // ●--------描画：場--------●
	onValue(pv_db_field, (snap) => {
	  if (isShop) return;
	
	  const cards = snap.val() || [];
	  const fieldDiv = document.getElementById("field");
	  fieldDiv.innerHTML = "";
	
	  const latestCard = cards.length > 0 ? cards[cards.length - 1] : null;
	
	  if (latestCard) {
	    const cardEl = document.createElement("div");
	    cardEl.className = "cardButton";
	    cardEl.innerHTML = `
	      <div class="cardName fieldName">${latestCard.name}</div>
	      <div class="cardText">${latestCard.text}</div>
	    `;
	    fieldDiv.appendChild(cardEl);
	  } else {
	    const empty = document.createElement("div");
	    empty.style.width = "80px";
	    empty.style.height = "120px";
	    empty.style.border = "2px dashed #aaa";
	    empty.style.borderRadius = "10px";
	    fieldDiv.appendChild(empty);
	  }
	});
	  
	onValue(ref(db, `rooms/${roomId}/players`), snap => {
	  const players = snap.val() || {};
	  const div = document.getElementById("playerList");
	  div.innerHTML = "参加者：" + Object.keys(players).join(", ");
	
	  if (isShop) {
	    renderTargetPlayerSelect(players);
	  }
	});
	  
    // ■■■■■■■■■■■■■■■■■■■■■■■■■■■
    // ■    ボタン動作            ■
    // ■■■■■■■■■■■■■■■■■■■■■■■■■■■
    
    // ●--------ボタン：カードを引く--------●
    document.getElementById("deckImage").addEventListener("click", drawCard);
    
    // ●--------ボタン：リセット--------●
    document.getElementById("reset").addEventListener("click", resetGame);
    
    // ●--------ボタン：シャッフル--------●
    document.getElementById("shuffleDeck").addEventListener("click", shuffleDeck);

	// ●--------ボタン：場を山札に戻す--------●
    document.getElementById("returnToDeck").addEventListener("click", returnFieldToDeck);
	document.getElementById("leaveRoom").addEventListener("click", leaveRoom);

	if (isShop) {
	  document.getElementById("deckImage").style.pointerEvents = "none";
	  document.getElementById("deckImage").style.opacity = "0.5";
	
	  document.getElementById("reset").style.display = "none";
	  document.getElementById("shuffleDeck").style.display = "none";
	  document.getElementById("returnToDeck").style.display = "none";
	  document.getElementById("topArea").style.display = "none";
	  document.getElementById("hand").style.display = "none";	
		document.getElementById("leaveRoom").style.display = "none";
	}
	  
    // ■■■■■■■■■■■■■■■■■■■■■■■■■■■
    // ■    関数                 ■
    // ■■■■■■■■■■■■■■■■■■■■■■■■■■■
    // ●--------カードを引く--------●
	async function drawCard() {
	  const deckSnap = await get(pv_db_deck);
	  const handSnap = await get(pv_db_hand);
	
	  let deck = deckSnap.val() || [];
	  let hand = handSnap.val() || [];
	
	  if (deck.length === 0) {
	    alert("山札がありません");
	    return;
	  }
	
	  const card = deck.shift();
	  hand.push(card);
	
	  await update(roomRef, {
	    [`decks/${pv_playerId}`]: deck,
	    [`hands/${pv_playerId}`]: hand
	  });
	}

    // ●--------場に出す--------●
    async function playCard(cardIndex) {
      const handSnap  = await get(pv_db_hand);
      const fieldSnap = await get(pv_db_field);
    
      let hand = handSnap.val() || [];
      let field = fieldSnap.val() || [];
    
      if (!hand[cardIndex]) return;
    
      const card = hand.splice(cardIndex, 1)[0]; // 手札から削除
      field.push(card);                           // 共通の場に追加
    
		await update(roomRef, {
		  [`hands/${pv_playerId}`]: hand,
		  [`fields/${pv_playerId}`]: field
		});
    }

    // ●--------リセット--------●
	async function resetGame() {
	  if (!confirm("ゲームをリセットしますか？")) return;
	
	  const playersSnap = await get(ref(db, `rooms/${roomId}/players`));
	  const players = playersSnap.val() || {};
	
		const decks = {};
		const hands = {};
		const fields = {};

		Object.keys(players).forEach(pid => {
			decks[pid] = [...initialDeck];
			hands[pid] = [];
			fields[pid] = [];
		});
	
	  await update(roomRef, {
	    decks,
	    hands,
	    fields,
	    shopDeck: [...shopDeck]
	  });
	}
    
    // ●--------シャッフル実行--------●
	async function shuffleDeck() {
	  const deckSnap = await get(pv_db_deck);
	  let deck = deckSnap.val() || [];

	  if (deck.length <= 1) {
		alert("シャッフルするカードがありません");
		return;
	  }

	  shuffleArray(deck);

	  await update(roomRef, {
  	    [`decks/${pv_playerId}`]: deck
  	  });
	}
    
    // ●--------デッキをシャッフル--------●
    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

	// ●--------場のカードを山札に戻す--------●
	async function returnFieldToDeck() {
	  if (!confirm("場のカードをすべて山札に戻しますか？")) return;
	
		const deckSnap  = await get(pv_db_deck);
		const fieldSnap = await get(pv_db_field);

	  let deck  = deckSnap.val() || [];
	  let field = fieldSnap.val() || [];
	
	  if (field.length === 0) {
	    alert("場にカードがありません");
	    return;
	  }
	
	  // 場のカードを山札の下に戻す
	  deck = deck.concat(field);
	
		await update(roomRef, {
			[`decks/${pv_playerId}`]: deck,
			[`fields/${pv_playerId}`]: []
		});
	}

	function renderShop() {
	  const shopDiv = document.getElementById("shopList");
	  shopDiv.innerHTML = "";
	
	  shopDeck.forEach(card => {
	    const cardEl = document.createElement("div");
	    cardEl.className = "cardButton";
	    cardEl.innerHTML = `
	      <div class="cardName">${card.name}</div>
	      <div class="cardText">${card.text.replace(/\n/g, "<br>")}</div>
	    `;
	
	    cardEl.onclick = () => addShopCardToPlayer(card);
	
	    shopDiv.appendChild(cardEl);
	  });
	}
	  
	function renderTargetPlayerSelect(players) {
	  const select = document.getElementById("targetPlayerSelect");
	  select.innerHTML = "";
	
	  Object.keys(players).forEach(pid => {
	    if (pid === "shop") return;
	
	    const opt = document.createElement("option");
	    opt.value = pid;
	    opt.textContent = pid;
	    select.appendChild(opt);
	  });
	}
	  
	async function addShopCardToPlayer(card) {
	  const select = document.getElementById("targetPlayerSelect");
	  const targetPlayer = select.value;
	
	  if (!targetPlayer) {
	    alert("追加先プレイヤーを選択してください");
	    return;
	  }
	
	  const deckRef = ref(db, `rooms/${roomId}/decks/${targetPlayer}`);
	  const snap = await get(deckRef);
	  const deck = snap.val() || [];
	
	  deck.push(card); // デッキの下に追加
	
	  await update(roomRef, {
	    [`decks/${targetPlayer}`]: deck
	  });
	
	  alert(`${targetPlayer} のデッキに追加しました`);
	}
	  
	// shopモードならカード一覧を表示
	if (isShop) {
	  renderShop();
	}
	  
	async function joinRoom() {
	  if (isShop) return;
	
	  const playerRef = ref(db, `rooms/${roomId}/players/${pv_playerId}`);
	  const snap = await get(playerRef);
	
	  if (!snap.exists()) {
	    await update(roomRef, {
	      [`players/${pv_playerId}`]: {
	        joinedAt: Date.now()
	      },
	      [`decks/${pv_playerId}`]: [...initialDeck],
	      [`hands/${pv_playerId}`]: []
	    });
	  }
	}

	joinRoom();

	async function leaveRoom() {
	  if (!confirm("部屋から退室しますか？")) return;
	
	  const updates = {};
	  updates[`players/${pv_playerId}`] = null;
	  updates[`decks/${pv_playerId}`]   = null;
	  updates[`hands/${pv_playerId}`]   = null;
	
	  await update(roomRef, updates);
	
	  alert("退室しました");
	
	  // 画面遷移（例）
	  window.location.href = "./index.html";
	}

  </script>
</body>
</html>
