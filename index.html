<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Paddle Duel</title>

<style>
  html,body{
    margin:0;padding:0;height:100%;overflow:hidden;
    background:#111;font-family:system-ui;
  }

  #stage{
    position:fixed;left:0;top:0;width:100vw;height:100vh;
    background:#222;display:none;overflow:hidden;
  }

  /* 右上タイトル */
  #title{
    position:fixed;right:3vw;top:2vw;
    font-size:5vw;color:white;z-index:100;
  }

  /* Room UI */
  #roomPanel{
    position:fixed;inset:0;background:#000c;
    display:flex;flex-direction:column;
    justify-content:center;align-items:center;
    gap:2rem;z-index:50;
  }
  #roomPanel input{
    width:70vw;font-size:6vw;padding:1rem;
  }
  #roomPanel button{
    font-size:6vw;padding:1rem 2rem;
  }

  /* HUD */
  #hud{
    position:fixed;left:3vw;top:2vw;color:#fff;
    font-size:4vw;z-index:100;
  }

  /* パドル */
  .paddle{
    position:absolute;width:22vw;height:3vh;
    background:#4af;border-radius:8px;
  }
  #enemyPaddle{background:#f55;top:5vh;} /* ← 上 */
  #myPaddle{bottom:8vh;}               /* ← 下（正しい位置） */

  /* ボール */
  #ball{
    position:absolute;width:4vw;height:4vw;border-radius:50%;
    background:#ffd;display:none;
  }

  /* Start / Leave */
  #topControls{
    position:fixed;right:3vw;bottom:20vh;
    display:flex;flex-direction:column;
    gap:1rem;z-index:200;
  }
  .tbtn{
    background:#333;color:#fff;border:2px solid #fff;
    padding:.8rem 1.4rem;font-size:5vw;border-radius:8px;
  }

  /* メッセージ */
  #msg{
    position:fixed;inset:0;display:flex;
    justify-content:center;align-items:center;
    font-size:10vw;color:white;z-index:300;
    opacity:0;transition:opacity .3s;
  }

  /* パドル移動ボタン */
  #controls{
    position:fixed;left:0;right:0;
    bottom:env(safe-area-inset-bottom,20px);
    display:flex;justify-content:center;
    gap:20vw;z-index:200;
  }
  .btn{
    background:#333;color:white;border:2px solid #fff;
    padding:1rem 2rem;font-size:8vw;border-radius:10px;
    user-select:none;
  }
</style>
</head>

<body>
<div id="roomPanel">
  <div style="color:white;font-size:7vw;">Room ID</div>
  <input id="roomInput" placeholder="abc123">
  <button id="joinBtn">Join</button>
</div>

<div id="stage">
  <div id="title">Paddle Duel</div>
  <div id="hud">Players: <span id="pcount">1</span></div>
  <div id="msg"></div>

  <div id="enemyPaddle" class="paddle"></div>
  <div id="myPaddle" class="paddle"></div>
  <div id="ball"></div>

  <div id="topControls">
    <div id="startBtn" class="tbtn">Start</div>
    <div id="leaveBtn" class="tbtn">Leave</div>
  </div>

  <div id="controls">
    <div id="leftBtn" class="btn">←</div>
    <div id="rightBtn" class="btn">→</div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set, onValue, remove, onDisconnect } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

/* ★ Firebase 設定をあなたのものに変更 ★ */
const firebaseConfig = {
  apiKey: "YOUR_KEY",
  authDomain: "your.firebaseapp.com",
  databaseURL: "https://your-default-rtdb.firebaseio.com",
  projectId: "your",
  storageBucket: "your.appspot.com",
  messagingSenderId: "xxx",
  appId: "xxx"
};

const app=initializeApp(firebaseConfig);
const db=getDatabase(app);

/* UI */
const roomPanel=document.getElementById("roomPanel");
const stage=document.getElementById("stage");
const msg=document.getElementById("msg");
const pcount=document.getElementById("pcount");

const myP=document.getElementById("myPaddle");
const opP=document.getElementById("enemyPaddle");
const ball=document.getElementById("ball");

const startBtn=document.getElementById("startBtn");
const leaveBtn=document.getElementById("leaveBtn");
const leftBtn=document.getElementById("leftBtn");
const rightBtn=document.getElementById("rightBtn");

let roomId=null;
let myId=Math.random().toString(36).slice(2,10);

let playersRef,ballRef,startRef,meRef;
let enemyId=null;
let gameStarted=false;

/* 状態 */
let myX=40;
let enemyX=40;
let ballX=50, ballY=50, vx=0, vy=0;

let moveLeft=false, moveRight=false;

/* 安定タッチ */
function bind(btn,on,off){
  btn.addEventListener("pointerdown",e=>{e.preventDefault();on();});
  btn.addEventListener("pointerup",off);
  btn.addEventListener("pointerleave",off);
}
bind(leftBtn,()=>moveLeft=true,()=>moveLeft=false);
bind(rightBtn,()=>moveRight=true,()=>moveRight=false);

/* Join */
document.getElementById("joinBtn").onclick=()=>{
  const id=document.getElementById("roomInput").value.trim();
  if(!id){ alert("Room ID 必須"); return; }
  joinRoom(id);
};

function joinRoom(id){
  roomId=id;
  roomPanel.style.display="none";
  stage.style.display="block";

  playersRef=ref(db,`rooms/${roomId}/players`);
  ballRef=ref(db,`rooms/${roomId}/ball`);
  startRef=ref(db,`rooms/${roomId}/start`);

  meRef=ref(db,`rooms/${roomId}/players/${myId}`);
  set(meRef,{id:myId,x:myX});
  onDisconnect(meRef).remove();

  onValue(playersRef,snap=>{
    const v=snap.val()||{};
    const keys=Object.keys(v);
    pcount.innerText=keys.length;

    enemyId=keys.find(k=>k!==myId);
    if(enemyId && v[enemyId]) enemyX=v[enemyId].x;
  });

  onValue(ballRef,snap=>{
    const b=snap.val();
    if(!b) return;
    ballX=b.x; ballY=b.y;
  });

  onValue(startRef,snap=>{
    if(snap.val() && !gameStarted){
      beginGame();
    }
  });
}

/* Start */
startBtn.onclick=()=>{
  if(!roomId) return;
  set(startRef,{go:true});
};

/* Leave */
leaveBtn.onclick=()=>{
  if(meRef) remove(meRef);
  location.reload();
};

function beginGame(){
  gameStarted=true;
  announce("Start!");

  vx = (Math.random()*0.5+0.3)*(Math.random()<0.5?-1:1);
  vy = -0.55;    /* 最初は相手側へ */

  ball.style.display="block";

  loop();
}

/* メッセージ */
function announce(t){
  msg.innerText=t;
  msg.style.opacity=1;
  setTimeout(()=>msg.style.opacity=0,1500);
}

function loop(){
  if(!gameStarted){ requestAnimationFrame(loop); return; }

  /* パドル移動 */
  if(moveLeft) myX-=0.9;
  if(moveRight) myX+=0.9;
  myX=Math.max(0,Math.min(78,myX));
  set(meRef,{id:myId,x:myX});
  myP.style.left=myX+"vw";

  /* 敵パドル */
  if(enemyId) opP.style.left=enemyX+"vw";

  /* ホストがボール更新 */
  if(myId < (enemyId||"zzzzzzzz")){

    ballX+=vx;
    ballY+=vy;

    /* 左右反射 */
    if(ballX<0 || ballX>96) vx*=-1;

    /* 衝突：敵パドル（上） */
    if(ballY<10){
      if(ballX>enemyX-2 && ballX<enemyX+22){
        vy*=-1;
      }
    }

    /* 衝突：味方パドル（下） */
    if(ballY>80){
      if(ballX>myX-2 && ballX<myX+22){
        vy*=-1;
      }
    }

    /* 勝敗 */
    if(ballY < -5){
      announce("You Win!");
      setTimeout(()=>location.reload(),1500);
    }
    if(ballY > 100){
      announce("You Lose");
      setTimeout(()=>location.reload(),1500);
    }

    set(ballRef,{x:ballX,y:ballY});
  }

  /* 表示 */
  ball.style.left=ballX+"vw";
  ball.style.top=ballY+"vh";

  requestAnimationFrame(loop);
}
</script>
</body>
</html>