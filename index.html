<!DOCTYPE html>
<html lang="ja">
<head> 
  <meta charset="UTF-8"> 
  <style>
    #deckImage {
      width: 80px;
      height: 120px;
      border-radius: 10px;
      background: repeating-linear-gradient(
          45deg,
          #2d2d7f,
          #2d2d7f 10px,
          #1a1a4f 10px,
          #1a1a4f 20px
        );
      border: 3px solid #000;
      box-shadow: 0 6px 8px rgba(0,0,0,0.4);
      margin-bottom: 5px;
      transition: transform 0.2s, opacity 0.3s;
    }
    
    /* マウスで浮く演出 */
    #deckImage:hover {
      transform: translateY(-5px);
    }
  
    #deckCount {
      margin-top: 5px;
      font-size: 16px;
      font-weight: bold;
    }
    
    #hand {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 20px;
    }
    
    .cardButton {
      width: 80px;
      height: 120px;
      margin: 5px;
      border-radius: 10px;
      border: 2px solid #000;
      background: repeating-linear-gradient(
          45deg,
          #ffffff,
          #ffffff 10px,
          #e5e5e5 10px,
          #e5e5e5 20px
      );
      font-size: 24px;
      font-weight: bold;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: 8px;
      align-items: center;
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
      cursor: pointer;
      transition: transform 0.15s;
    }

    .cardButton div:nth-child(1) {
      font-size: 20px;
      font-weight: bold;
    }
    
    .cardButton div:nth-child(2) {
      font-size: 12px;
    }
    
    .cardButton:hover {
      transform: translateY(-4px);
    }

    #topArea {
      display: flex;
      align-items: center;
      gap: 40px; /* デッキと場の間の余白 */
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <!-- ■■■■■■■■■■■■■■■■■■■■■■■■■■■ -->
  <!-- ■    画面構成              ■ -->
  <!-- ■■■■■■■■■■■■■■■■■■■■■■■■■■■ -->
  <div>
    <button id="reset">リセット【Ver：16】</button>
  </div>
  <div id="topArea">
    <div id="deck">
      <div id="deckImage"></div>
      <div id="deckCount"></div>
    </div>
  
    <div id="field"></div>
  </div>
  <div id="hand"></div>

  <script type="module">
    // ■■■■■■■■■■■■■■■■■■■■■■■■■■■
    // ■    Firebase設定         ■
    // ■■■■■■■■■■■■■■■■■■■■■■■■■■■
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
    import {
      getDatabase,
      ref,
      get,
      set,
      update,
      onValue
    } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-database.js";

    const firebaseConfig = {
        apiKey:            "AIzaSyAs8DqxHiRzveAMJ7j-UMBWKp6ztGF-hd8",
        authDomain:        "ddgame-6f5f8.firebaseapp.com",
        databaseURL:       "https://ddgame-6f5f8-default-rtdb.firebaseio.com",
        projectId:         "ddgame-6f5f8",
        storageBucket:     "ddgame-6f5f8.firebasestorage.app",
        messagingSenderId: "172945824128",
        appId:             "1:172945824128:web:e3c7333928e1545aa1c965",
        measurementId:     "G-FG0645HHZD"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    // ■■■■■■■■■■■■■■■■■■■■■■■■■■■
    // ■    変数・定数            ■
    // ■■■■■■■■■■■■■■■■■■■■■■■■■■■
    const roomId   = "room1";
    const initialDeck = [
      { name: "A", text: "攻撃力 +2" },
      { name: "B", text: "相手の手札を1枚捨てさせる" },
      { name: "C", text: "カードを2枚引く" },
      { name: "D", text: "自分のカードを守る" },
      { name: "E", text: "相手のカードをコピー" },
      { name: "F", text: "次のターン行動不可" },
      { name: "G", text: "攻守逆転" },
      { name: "H", text: "デッキの上3枚を見る" },
      { name: "I", text: "手札+1" },
      { name: "J", text: "特殊勝利条件" }
    ];

    // URLからプレイヤーIDを取得
    const pv_urlParams = new URLSearchParams(window.location.search);
    const pv_playerId = pv_urlParams.get("player") || "playerA"; // デフォルト playerA

    const roomRef     = ref(db, `rooms/${roomId}`);
    const pv_db_deck  = ref(db, `rooms/${roomId}/deck`);
    const pv_db_hand  = ref(db, `rooms/${roomId}/hands/${pv_playerId}`);
    const pv_db_field = ref(db, `rooms/${roomId}/field/${pv_playerId}`);
    const pv_db_field_all = ref(db, `rooms/${roomId}/field`);

    // ■■■■■■■■■■■■■■■■■■■■■■■■■■■
    // ■    リアルタイム表示      ■
    // ■■■■■■■■■■■■■■■■■■■■■■■■■■■
    // ●--------描画：デッキ--------●
    onValue(pv_db_deck, (lv_snapshot_deck) => {
      const lv_deck = lv_snapshot_deck.val() || [];
      document.getElementById("deckCount").innerHTML = `残り：${lv_deck.length}枚`;

      const img = document.getElementById("deckImage");
      img.style.opacity = lv_deck.length === 0 ? "0.3" : "1"; // デッキが0なら薄くする
    });

    // ●--------描画：手札--------●
    onValue(pv_db_hand, (lv_snapshot_hand) => {
      const lv_hand = lv_snapshot_hand.val() || [];
      const handDiv = document.getElementById("hand");
      handDiv.innerHTML = "";
    
      lv_hand.forEach((card, index) => {
        const btn = document.createElement("div");
        btn.className = "cardButton";
        btn.textContent = card.name + "\n" + card.text;
        btn.innerHTML = `
          <div style="font-size:20px; font-weight:bold;">${card.name}</div>
          <div style="font-size:12px;">${card.text}</div>
        `;
        btn.onclick = () => playCard(index);  // カードを場に出す
      
        handDiv.appendChild(btn);
      });
    });

    // ●--------描画：場--------●
    onValue(ref(db, `rooms/${roomId}/field`), (snap) => {
      const cards = snap.val() || [];
      const fieldDiv = document.getElementById("field");
      fieldDiv.innerHTML = "";
    
      const latestCard = cards.length > 0 ? cards[cards.length - 1] : null;
    
      if (latestCard) {
        const cardEl = document.createElement("div");
        cardEl.className = "cardButton";
        cardEl.textContent = latestCard;
        cardEl.innerHTML = `
          <div style="font-size:20px; font-weight:bold;">${latestCard.name}</div>
          <div style="font-size:12px;">${latestCard.text}</div>
        `;
        fieldDiv.appendChild(cardEl);
      } else {
        const empty = document.createElement("div");
        empty.style.width = "80px";
        empty.style.height = "120px";
        empty.style.border = "2px dashed #aaa";
        empty.style.borderRadius = "10px";
        fieldDiv.appendChild(empty);
      }
    });
    // ■■■■■■■■■■■■■■■■■■■■■■■■■■■
    // ■    ボタン動作            ■
    // ■■■■■■■■■■■■■■■■■■■■■■■■■■■
    
    // ●--------ボタン：カードを引く--------●
    document.getElementById("deckImage").addEventListener("click", drawCard);
    
    // ●--------ボタン：リセット--------●
    document.getElementById("reset").addEventListener("click", resetGame);
    // ■■■■■■■■■■■■■■■■■■■■■■■■■■■
    // ■    関数                 ■
    // ■■■■■■■■■■■■■■■■■■■■■■■■■■■
    // ●--------カードを引く--------●
    async function drawCard() {
      const deckSnap = await get(pv_db_deck);
      const handSnap = await get(pv_db_hand);

      let deck = deckSnap.val() || [];
      let hand = handSnap.val() || [];

      if (deck.length === 0) {
        alert("山札がありません");
        return;
      }

      const card = deck.shift(); // 山札の一番上を引く
      hand.push(card);           // 手札に追加

      // --- データ更新（同時更新対策で update を使う） ---
      await update(roomRef, {
        deck: deck,
        [`hands/${pv_playerId}`]: hand
      });
    }

    // ●--------場に出す--------●
    async function playCard(cardIndex) {
      const handSnap  = await get(pv_db_hand);
      const fieldSnap = await get(ref(db, `rooms/${roomId}/field`));  // 共通の場に変更
    
      let hand = handSnap.val() || [];
      let field = fieldSnap.val() || [];
    
      if (!hand[cardIndex]) return;
    
      const card = hand.splice(cardIndex, 1)[0]; // 手札から削除
      field.push(card);                           // 共通の場に追加
    
      await update(roomRef, {
        [`hands/${pv_playerId}`]: hand,
        field: field
      });
    }

    // ●--------リセット--------●
    async function resetGame() {
      if (!confirm("ゲームをリセットしますか？")) return;
    
      await update(roomRef, {
        deck: [...initialDeck],
        hands: {},
        field: []
      });
    
    }
  </script>
</body>
</html>
